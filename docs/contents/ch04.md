# 第4章 搜索策略

## 1 搜索引擎的发展

1. 分类目录时代：1990年的`Archie`，用于FTP软件上的文件搜索，1994年的`Lycos`主要按分类目录进行搜索。
2. 文本检索时代：支持用户输入检索词并返回信息的检索方式，系统通过计算检索词与网页文本内容的相关度，返回相关网页并进行排序。
3. 链接分析时代：基于`PageRank`技术，高效匹配用户的检索词和网页内容，返回高关联度的相关内容并过滤低质内容，结合内容的流行性和权威性，对所有内容进行科学的排序。
4. 多功能+人性化+弱人工智能时代：基于用户画像精准返回符合用户个性化需求的搜索结果，对搜索结果进行科学排序。
5. 强人工智能时代：结合ChatGPT能力，具备知识问答的功能，可以根据用户的问题提供对应的答案。

## 2 搜索引擎概述

### 2.1 基本概念

- 定义：搜索引擎本质上是一种信息检索系统，从海量的信息中检索出和用户查询相关的信息。
- 实现目标：精准、全面、可运营、可反哺
- 需要解决的关键问题：
  - 准确识别用户的查询意图
  - 实现查询和物料的匹配
  - 科学地对返回的物料进行排序
  - 做到有问必答，解决用户大部分查询需求

### 2.2 整体架构

- 搜索前和搜索中的模块：设置搜索底纹、搜索排行榜、搜索联想词等，进行自动纠错。
- 查询语义理解：充分理解用户的检索词，构建查询语法树，输入召回模块中。
- 词库和实体体系：`IK`分词、`jieba`分词或构建自己的词库。
- 召回：文本召回、语义相关性召回、个性化召回。
- 物料索引：针对物料提前构建倒排索引。
- 过滤：在粗排和精排环节前，避免无效物料进入后续环节，提前过滤无效物料，减少后续环节的计算量。
- 粗排：对搜索结果进行初筛。
- 精排：实现单点最优，预估单个搜索结果的CTR和CVR。
- 重排：以序列最优为核心目标对搜索结果进行重排。
- 搜索后模块：样式和创意策略。
- 特征服务：推荐系统和搜索引擎共用一个大的特征服务模块。

### 2.3 常见效果评估指标

**离线评估指标：**
- 数据标注：需要基于实际业务情况和用户反馈来制定，没有统一要求。
- 召回完整性
- 排序合理性：
  - DCG（折损累计收益）指标：$\displaystyle \text{DCG} = \sum_{i=1}^n \frac{\text{rel}_i}{\log_2 (i + 1)}$，其中$\text{rel}_i$表示第$i$位的得分情况。
  - NDCG（归一化折损累计收益）指标：$\displaystyle \text{NDCG} = \frac{\text{DCG}}{\text{IDCG}}$，其中`IDCG`表示理论上排序最优的搜索结果对应的DCG分数。

**在线评估指标：**
- 查询无结果率：反映搜索引擎召回时无结果次数的比例，指标越高，效果越差。
$$
\text{查询无结果率} = \frac{\text{无结果返回的PV数}}{\text{总搜索PV数}}
$$

- 平均点击结果位数：反映搜索引擎对召回结果排序的合理性，指标越小，效果越好。
$$
\text{平均点击结果位数} = \frac{\text{总点击结果位数}}{\text{总搜索PV数}}
$$

- 跳失率：反映用户进入搜索结果页面以后，没有任何操作并且直接推出的比例，指标越高，效果越差。
$$
\text{跳失率} = \frac{\text{跳失PV数}}{\text{总搜索PV数}}
$$

- CTR：分为UV、PV和曝光件次口径。
$$
\text{CTR} = \frac{\text{点击结果数}}{\text{曝光结果数}}
$$

- CVR：分为UV、PV和曝光件次口径。
$$
\text{CVR} = \frac{\text{订单数}}{\text{点击数}}
$$

## 3 搜索策略产品经理画像

- 召回：查询语义理解模块策略、召回模块策略。
- 排序：整体流量分发策略制定、排序公式的设计、精排模型和重排模型的样本选择、特征工程等。
- 平台生态：负责搜索策略的运营工作，每日需要评估大量的搜索结果，评估搜索结果和检索词的相关性以及排序的合理性等。

## 4 搜索引擎实体识别

- 实体识别：对检索词中具有特定意义的语义实体进行识别，根据识别的结果构建召回策略和排序策略。
- 构建全面的实体体系，有助于搜索引擎精准识别复杂的检索词。

## 5 搜索引擎词库

- 词库格式：词库里的每一个词需要具备词频和词性两个基本属性。
- 词库构建：开源词库、人工标注。

## 6 搜索引擎物料索引

- 正排索引：遍历所有的物料，然后查找每一个物料中是否存在和该查询词相匹配的实体，如果存在匹配的实体，则记录这条物料的SKU_ID，最终查找出所有包含该查询词的物料。
  - 优点：构建索引简单且迅速，方便管理。
  - 缺点：必须遍历所有的物料，检索效率低下。
- 倒排索引：以词或实体为关键词进行检索，表中的每一行记录为包含该索引关键词的物料在平台上的标识ID。
  - 优点：检索效率极高。
  - 缺点：索引的初期构建和后期维护较为复杂。

- 二者差异：正排索引是物料到关键信息的映射，倒排索引是关键信息到物料的映射。
- 搜索引擎均使用倒排索引进行信息检索，使用正排索引进行物料信息补全。
- 物料的信息源：标签体系、物料的标题、物料正文里的实际内容。

## 7 搜索引擎查询语义理解

### 7.1 归一化

对检索词进行大小写统一、将拼音转为汉字、将英文转为中文、去除特殊符号等。

### 7.2 纠错

- 检索词出现错误的原因：拼音问题、知识错误
- 检索词纠错方法：
  - 基于词典的方法：构建错误检索词和正确检索词的映射表。
  - 基于规则的方法：召回（计算与词库里面其他词的编辑距离，召回距离比较小的词）、排序（将拼音完全相同的词排在前列）
  - 基于`N-Gram`语言模型的方法：建立N元模型，得到多个词组成的序列，基于中文编辑距离和拼音编辑距离进行相似短语的召回。
- 检索词纠错的评估指标：
  - 召回率：$\displaytstyle \text{召回率} = \frac{\text{错误的检索词被纠正的个数}}{\text{错误的检索词个数}}$
  - 过纠率：$\displaytstyle \text{过纠率} = \frac{\text{正确的检索词被纠正的个数}}{\text{正确的检索词个数}}$
- 检索词的触发方式：
  - 词典触发：检索词是纠错词表里面的错误词。
  - 零少结果触发：搜索结果极少，触发纠错。
  - 不管原始检索词结果如何，全部针对原始检索词进行纠错，对比新旧检索词出现的概率。

### 7.4 分词


