# 第4章 搜索策略

## 1 搜索引擎的发展

1. 分类目录时代：1990年的`Archie`，用于FTP软件上的文件搜索，1994年的`Lycos`主要按分类目录进行搜索。
2. 文本检索时代：支持用户输入检索词并返回信息的检索方式，系统通过计算检索词与网页文本内容的相关度，返回相关网页并进行排序。
3. 链接分析时代：基于`PageRank`技术，高效匹配用户的检索词和网页内容，返回高关联度的相关内容并过滤低质内容，结合内容的流行性和权威性，对所有内容进行科学的排序。
4. 多功能+人性化+弱人工智能时代：基于用户画像精准返回符合用户个性化需求的搜索结果，对搜索结果进行科学排序。
5. 强人工智能时代：结合ChatGPT能力，具备知识问答的功能，可以根据用户的问题提供对应的答案。

## 2 搜索引擎概述

### 2.1 基本概念

- 定义：搜索引擎本质上是一种信息检索系统，从海量的信息中检索出和用户查询相关的信息。
- 实现目标：精准、全面、可运营、可反哺
- 需要解决的关键问题：
  - 准确识别用户的查询意图
  - 实现查询和物料的匹配
  - 科学地对返回的物料进行排序
  - 做到有问必答，解决用户大部分查询需求

### 2.2 整体架构

- 搜索前和搜索中的模块：设置搜索底纹、搜索排行榜、搜索联想词等，进行自动纠错。
- 查询语义理解：充分理解用户的检索词，构建查询语法树，输入召回模块中。
- 词库和实体体系：`IK`分词、`jieba`分词或构建自己的词库。
- 召回：文本召回、语义相关性召回、个性化召回。
- 物料索引：针对物料提前构建倒排索引。
- 过滤：在粗排和精排环节前，避免无效物料进入后续环节，提前过滤无效物料，减少后续环节的计算量。
- 粗排：对搜索结果进行初筛。
- 精排：实现单点最优，预估单个搜索结果的CTR和CVR。
- 重排：以序列最优为核心目标对搜索结果进行重排。
- 搜索后模块：样式和创意策略。
- 特征服务：推荐系统和搜索引擎共用一个大的特征服务模块。

### 2.3 常见效果评估指标

**离线评估指标：**
- 数据标注：需要基于实际业务情况和用户反馈来制定，没有统一要求。
- 召回完整性
- 排序合理性：
  - DCG（折损累计收益）指标：$\displaystyle \text{DCG} = \sum_{i=1}^n \frac{\text{rel}_i}{\log_2 (i + 1)}$，其中$\text{rel}_i$表示第$i$位的得分情况。
  - NDCG（归一化折损累计收益）指标：$\displaystyle \text{NDCG} = \frac{\text{DCG}}{\text{IDCG}}$，其中`IDCG`表示理论上排序最优的搜索结果对应的DCG分数。

**在线评估指标：**
- 查询无结果率：反映搜索引擎召回时无结果次数的比例，指标越高，效果越差。
$$
\text{查询无结果率} = \frac{\text{无结果返回的PV数}}{\text{总搜索PV数}}
$$

- 平均点击结果位数：反映搜索引擎对召回结果排序的合理性，指标越小，效果越好。
$$
\text{平均点击结果位数} = \frac{\text{总点击结果位数}}{\text{总搜索PV数}}
$$

- 跳失率：反映用户进入搜索结果页面以后，没有任何操作并且直接推出的比例，指标越高，效果越差。
$$
\text{跳失率} = \frac{\text{跳失PV数}}{\text{总搜索PV数}}
$$

- CTR：分为UV、PV和曝光件次口径。
$$
\text{CTR} = \frac{\text{点击结果数}}{\text{曝光结果数}}
$$

- CVR：分为UV、PV和曝光件次口径。
$$
\text{CVR} = \frac{\text{订单数}}{\text{点击数}}
$$

## 3 搜索策略产品经理画像

- 召回：查询语义理解模块策略、召回模块策略。
- 排序：整体流量分发策略制定、排序公式的设计、精排模型和重排模型的样本选择、特征工程等。
- 平台生态：负责搜索策略的运营工作，每日需要评估大量的搜索结果，评估搜索结果和检索词的相关性以及排序的合理性等。

## 4 搜索引擎实体识别

- 实体识别：对检索词中具有特定意义的语义实体进行识别，根据识别的结果构建召回策略和排序策略。
- 构建全面的实体体系，有助于搜索引擎精准识别复杂的检索词。

## 5 搜索引擎词库

- 词库格式：词库里的每一个词需要具备词频和词性两个基本属性。
- 词库构建：开源词库、人工标注。

## 6 搜索引擎物料索引

- 正排索引：遍历所有的物料，然后查找每一个物料中是否存在和该查询词相匹配的实体，如果存在匹配的实体，则记录这条物料的SKU_ID，最终查找出所有包含该查询词的物料。
  - 优点：构建索引简单且迅速，方便管理。
  - 缺点：必须遍历所有的物料，检索效率低下。
- 倒排索引：以词或实体为关键词进行检索，表中的每一行记录为包含该索引关键词的物料在平台上的标识ID。
  - 优点：检索效率极高。
  - 缺点：索引的初期构建和后期维护较为复杂。

- 二者差异：正排索引是物料到关键信息的映射，倒排索引是关键信息到物料的映射。
- 搜索引擎均使用倒排索引进行信息检索，使用正排索引进行物料信息补全。
- 物料的信息源：标签体系、物料的标题、物料正文里的实际内容。

## 7 搜索引擎查询语义理解

### 7.1 归一化

对检索词进行大小写统一、将拼音转为汉字、将英文转为中文、去除特殊符号等。

### 7.2 纠错

- 检索词出现错误的原因：拼音问题、知识错误
- 检索词纠错方法：
  - 基于词典的方法：构建错误检索词和正确检索词的映射表。
  - 基于规则的方法：召回（计算与词库里面其他词的编辑距离，召回距离比较小的词）、排序（将拼音完全相同的词排在前列）
  - 基于`N-Gram`语言模型的方法：建立N元模型，得到多个词组成的序列，基于中文编辑距离和拼音编辑距离进行相似短语的召回。
- 检索词纠错的评估指标：
  - 召回率：$\displaytstyle \text{召回率} = \frac{\text{错误的检索词被纠正的个数}}{\text{错误的检索词个数}}$
  - 过纠率：$\displaytstyle \text{过纠率} = \frac{\text{正确的检索词被纠正的个数}}{\text{正确的检索词个数}}$
- 检索词的触发方式：
  - 词典触发：检索词是纠错词表里面的错误词。
  - 零少结果触发：搜索结果极少，触发纠错。
  - 不管原始检索词结果如何，全部针对原始检索词进行纠错，对比新旧检索词出现的概率。

### 7.3 分词

- 分词面临的挑战：
  - 同一个语句可以由多种切分方法
  - 未登录词识别
- 基于词库的分词方法
  - 正向最长匹配（FMM）：从句子的最左侧开始进行匹配，不断地从词库中匹配长度最长的词，直到把句子全部切分完毕。
  - 逆向最长匹配（RMM）：从最右侧开始匹配，不断地从词库中匹配长度最长的词，直到把句子全部切分完毕。
  - 双向最长匹配：同时使用FMM和RMM进行分词，如果两者词数不一样，则优先选择词数较少的。
- 基于语言模型的分词方法：使用N-Gram语言模型预测分词序列组合在一起形成一个通顺语句的概率，最后选择概率最高的一组分词序列。
- 基于字的分词方法：将字分为4类，分别是词首（B）、词中（M）、词尾（E）和单字词（S），将分词问题转换为针对汉字的序列标注任务。
- 分词效果的评估：
  - 精准率：$\displaystyle P = \frac{\text{实际分词后得到的正确分词数}}{\text{实际分词后得到的词数}}$
  - 召回率：$\displaystyle R = \frac{\text{实际分词后得到的正确分词数}}{\text{正确分词后得到的词数}}$
  - $F_1$：$\displaystyle F_1 = \frac{2PR}{P + R}$
  - 未登录词召回率：$\displaystyle \text{未登录词召回率} = \frac{\text{实际分词中精准识别的未登录词总数}}{\text{语句中出现的未登录词总数}}$
  - 登录词召回率：$\displaystyle \text{登录词召回率} = \frac{\text{实际分词中精准识别的登录词总数}}{\text{语句中出现的登录词总数}}$
- 去停用词：可使用`jieba`分词、`Hanlp`等开源分词器，在最终的分词结果里将停用词去除。

### 7.4 实体识别

- 基于词库的识别方法
- 基于序列标注模型的识别方法：使用标签表示方法，即实体首（B）、实体中（M）和非实体（O）。

### 7.5 类目预测

- 类目预测的目标：有助于更好地计算检索词与物料之间的相关性，在后续相关性排序环节中，将关联度更高的类目物料排在前列。
- 类目预测方法：
  - 基于人工规则
  - 基于用户行为的数据统计
  - 基于类目预测模型：使用DNN构建多分类模型进行预测，当检索词与类目的预测相关性超过0.5时，才能说明两者之间的相关性可信。

### 7.6 查询改写

- 查询改写的原因：
  - 针对简洁的检索词，尽可能扩充召回条件，丰富召回结果。
  - 针对复杂的检索词，尽可能精简召回条件，提升检索效率。
- 改写方法：
  - 基于同义词的改写
  - 对于长尾检索词通过其他辅助行为信息进行改写
- 使用方法：用原始检索词和改写后的检索词一起构建召回条件，进行物料检索。

## 8 搜索引擎召回策略

### 8.1 文本相关性召回

- 基于实体重要性构建查询语法树：将实体重要性分为高、中、低3类，进行组合查询。
- 基于预测类目召回构建查询语法树
- 4种匹配规则：精准匹配、左匹配、右匹配、包含

### 8.2 语义相关性召回

- 向量召回的核心方法：构建语义相似度模型，评估检索词隐语义向量与文档隐语义向量之间的相关性，召回与检索词语义相关性高的文档。
- 电商领域相似度模型的构建：基于双塔模型的检索词塔和文档塔构建模型，正样本使用线上检索词返回结果的点击记录和人工标注的长尾检索词，负样本使用具有一定相关性但还不足以召回的数据。
- 相关性控制模型与语义相关性召回模型的差异：
  - 输出不同：语义相关性召回模型输出的是检索词与文档的相似度，是一个具体数值，而不是类别。相关性控制模型输出的是类别（相关或不相关）
  - 使用数据不同：语义相关性召回模型训练时，使用的核心数据来自线上点击曝光数据，而相关性控制模型训练时，使用的数据主要是人工标注数据，需要确保检索词与文档的严格相关性。

### 8.3 个性化召回

- 个性化召回模型：以语义相关性召回模型为基础，关注用户的个人喜好和物料的属性特征。
- 模型结构：基于双塔模型的用户/检索词塔和文档塔构建模型。
- 模型特征：
  - 用户个性化特征：用户的基础画像特征、用户的行为特征。
  - 文档个性化特征：电商领域的个性化特征包括商品三级品类、品牌、历史销量等，内容推荐领域的个性化特征包括内容题材、内容标签、内容历史数据等。

### 8.4 效果评估

- 离线评估：通过标注的数据计算召回率、DCG和NDCG指标。
- 线上评估：AB Test方式，关注CTR、CVR等指标。

## 9 搜索引擎粗排策略

- 粗排公式：
  - 整体粗排公式：$\text{Score}_\text{粗排} = a \times \text{相关性分} + b \times \text{质量分} + c \times \text{转化效率分}$
  - 相关性分数：$\text{相关性分数} = a \times \text{文本相关性} + b \times \text{向量相关性} + c \times \text{个性化相关性}$
  - 物料质量分：取决于物料历史线上表现效果，以及物料的创作者和商家对平台整体生态建设的贡献。
  - 转化效率分：由物料的CTR和CVR两方面评估得出的。
- 分数融合：将相关性分和质量分设置区间，处于同一个档次的为一级，相同级别的物料仅参考转化效率分排序，最终可以选择排序前1000位的物料。

## 10 搜索引擎精排策略

- 相关性排序：可以结合物料以往的线上效果表现和其他效果指标进行综合性排序。
- 多目标排序：基于DNN模型，针对每一个物料得到对应的预估$\text{CTR}_{\text{精排}}$和预估$\text{CVR}_{\text{精排}}$，最终得到对应的精排分数，然后按照分数进行倒排，一次请求返回百级别以内的物料。
- 特征工程：特征包括检索词、检索词品类、检索词和用户ID、检索词和商品ID、检索词和用户浏览行为序列、检索词和用户购买行为序列。

**PageRank算法：**
- 基本假设：数量假设（如果一个网页被其他网页链接的数量越多，入链数越多，则该网页越重要）、质量假设（如果一个网页被高质量的网页链接，说明被链接的网页质量也很高，权威性也很强）
- 输入表示： 
> 网页的节点数据集合是$V=(v_i)$，$v_i$表示单个节点。  
> 网页链接数据$E={e_{ij}}, i,j = 1,2 \cdots, n$；$e_{ij}$表示单个连接，每个节点的出度用$O(v_i)$表示。  
> 收敛条件为$\varepsilon$。  

- 算法步骤：
> 1. 为每个网页节点的PR值初始化为$\displaystyle \frac{1}{N}$，$N$为节点总数。  
> 2. 从$t=0$进行循环，直到各个节点的PR值收敛  
> $$\displaystyle \text{PR}_{v_i}^{t+1} = \sum_{v_j \in I(v_j)} \frac{\text{PR}_{v_j}^t}{O(v_j)}$$  
> 其中，$I(v_j)$表示所有指向节点$v_i$的节点集合；$\text{PR}_{v_j}^t$表示第$t$次循环下$v_j$节点的PR值；$O(v_j)$表示节点$v_j$的出度。  
> $R_t = [\text{PR}_{v_1}^t, \text{PR}_{v_2}^t, \cdots, \text{PR}_{v_N}^t]^T$，如果$\| R_{t+1} - R_t \| < \varepsilon$，则跳出循环不再迭代。  
> 3. 输出最终收敛的$R_t$值，作为每个节点的PR值，PR值越大，表示网页越重要。

- PageRank算法优化：
$$
R_{t+1} = d \times M \times R_t + \frac{1 + d}{N} \times E
$$

## 11 搜索引擎重排策略

- 全局最优策略：排序优化方式分为单点优化（point wise）、成对优化（pair wise）、序列优化（list wise）。
- 用户体验策略：结合搜索场景，基于检索词返回的物料都是相同类目，一般针对同商家、同创作者、同首图的打散方法。
- 流量调控策略：完全使用推荐策略中的流量调控策略。

## 12 搜索结果样式和创意策略

- 样式策略：
  - 物料样式：用于展示店铺物料的位置都是固定的（顶部或者腰部），只针对一些头部品牌在部分检索词下返回对应的店铺物料。
  - 排列样式：单列样式（左侧为图片、视频或者直播，右侧为内容标题及附加创意），双列样式（上方展示内容封面，下方展示内容标题、价格等信息）。
- 创意策略：重点优化商品的标题、附加创意等。

## 13 搜索结果用户体验策略

- 产品功能：
  - 用户问卷调查：对于选择精准高效的用户，将召回策略的相关性分数和阈值提高，尽量少穿插一些其他内容；对于闲逛发现的用户，适当多召回相关性低但是CTR或CVR高的商品，同时穿插一些其他不同样式的内容。
  - 大家都在搜：推荐搜索词，统计线上所有用户在搜索了原始检索词后切换的检索词，或计算原始检索词和其他热门检索词之间的语义相似度。
- 底层策略：对同店铺、同首图打散，并保证内容安全。
- 主观评估：通过GSB主观评估方法对比新旧模型的效果。

## 14 搜索产品功能

- 搜索底纹：
  - 目的：帮助用户免去输入步骤，引导用户主动搜索某些检索词。
  - 召回策略：结合近期的热门话题主动配置的检索词、商业化广告等检索词作为搜索底纹。
  - 排序策略：展示优先级为广告>运营配置>生成，一般为千人一面。
- 搜索联想词：
  - 目的：自动为用户推荐一些包含当前检索词的其他搜索词。
  - 召回策略：搜索历史、规则生成、排行榜。
  - 排序策略：基于搜索频次、基于联想词的质量分（$\text{Score} = a \times \text{搜索频次归一化分数} + b \times \text{搜索结果转化率} + c \times \text{搜索结果点击率}$）、基于联想词CTR预估。
  - 效果评估：离线评估（设置大量的测试案例，分别测试不同策略下可以召回联想词的数量，最后比较排序的合理性）、在线评估（测试联想词本身的点击率和转化率）。
- 搜索导航栏：
  - 整体策略：触发的检索词在电商领域一般都是一级或二级类目词，也可基于检索词匹配生成子类目词。
  - 召回和排序策略：初期基于业务判断设置固定顺序，后期可以做千人一面的动态调控，主要基于商品近期的曝光和点击数据进行倒排，定期更新。
- 搜索发现：
  - 目的：推荐一些搜索词
  - 召回和排序策略：推荐的搜索词包括历史搜索词、热门搜索词、广告词、运营配置词、排行榜等。
- 搜索排行榜：
  - 目的：搜索页最下方展示一些搜索热榜和其他权威排行榜。
  - 召回策略：电商领域（热搜榜和各个品类方向的细分权威榜单）、短视频领域（平台真实的热门搜索、运营人工配置）
  - 排序策略：基本上都是千人一面。
- 搜索二次筛选：
  - 目的：在垂直类搜索引擎中常见。主要筛选和商品属性相关。
  - 标签体系：体系构建、物料打标、标签排序
> 标签体系和实体体系的对比：
> - 认知的对象不同：标签体系是用来对物料进行认知，实体体系是用来对检索词进行认知。
> - 构建的对象不同：标签体系的构建需要结合该类目物料的业务属性和用户的主要关注点。

## 15 多模态搜索

- 以图搜图：基于CV技术和NLP技术，将两张图片进行特征向量化，计算之间的相似度。
- 识曲搜索：基于语音识别和旋律识别，评估两首歌曲之间的相似度。
- 视频搜索：
  - 通过文本搜视频：对文本质量治理，通过多模态技术充分理解视频内容。
  - 视频匹配：用于在短视频网站上针对创作者上传的视频进行重复性校验。
  - 视频合规性管控：对创作者上传的视频进行识别和匹配，通过OCR技术视频途中的文字，语音识别技术识别视频中的语音，然后与黑词库和黑音频库进行匹配。

