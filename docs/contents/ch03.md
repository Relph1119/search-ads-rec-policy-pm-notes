# 第3章 推荐策略

## 1 推荐系统概述

### 1.1 定义

- 定义：推荐系统的本质是一种信息过滤系统，用来预测用户对于物料的评分和偏好，建立用户与物料之间的连接。
- 解决问题：主要解决信息过载和长尾问题
- 输入数据：推荐系统基于历史数据来进行学习。
- 实现方式：推荐系统的核心是兴趣度预估模型（即CTR预估模型）
- 发展阶段：
  - 【1.0阶段】基于内容的推荐：依赖标签体系，需要基于业务知识建立一个全面的领域标签体系。
  - 【2.0阶段】协同过滤：使用用户的历史行为数据，通过用户与物料的交互数据，评估物料与物料、用户与用户之间的关联度。
  - 【3.0阶段】多路召回+精排：直接预估用户对物料的点击率（CTR）。
  - 【4.0阶段】深度学习+重排+样式创意：核心技术是深度学习技术，加入重排模块，在样式创意上进行大量的策略优化。

### 1.2 整体架构

- 物料索引：物料池存储在数据库中，提前构建好物料索引。
- 召回层：初筛出用户感兴趣的物料，返回的物料量级一般为万级别。
- 粗排层：对各路召回的物料进行再排序，取排序靠前的物料，输出千以内的物料数。
- 过滤层：将那些最终不能在App前端展示的物料过滤掉。
- 精排层：预估粗排层返回的前几位商品的$P_{\text{CTR}}$或$P_{\text{CVR}}$。
- 重排层：从全局最优的角度微调物料顺序，物料量都在十级别。
- App前端：App基于推荐系统返回的物料进行相关样式和创意信息的补充，将完整的信息展示在App前端。
- 特征服务：底层的基础服务，有大量用户的特征、物料的特征、场景的特征，都已经加工好的。

### 1.3 常见效果评估指标

#### 1.3.1 电商推荐场景

- CTR（点击率）
$$
\text{CTR}_{\text{曝光件次口径}} = \frac{\text{点击结果数}}{\text{曝光结果数}} \\
\text{CTR}_{\text{UV口径}} = \frac{\text{点击UV数}}{\text{曝光UV数}} \\
\text{CTR}_{\text{PV口径}} = \frac{\text{点击PV数}}{\text{曝光PV数}}
$$
`UV`表示用户维度的浏览量，`PV`表示页面浏览量，曝光件次表示曝光的总结果数。

- 加购率：介于CTR和CVR之间的中间指标
$$
\text{加购率}_{\text{点击件次口径}} = \frac{\text{加购数}}{\text{点击结果数}}
$$

- CVR（转化率）：最终的结果指标
$$
\text{CVR}_{\text{点击件次口径-订单量}} = \frac{\text{订单量}}{\text{点击结果数}} \\
\text{CVR}_{\text{点击件次口径-订单行量}} = \frac{\text{订单行量}}{\text{点击结果数}} \\
\text{CVR}_{\text{UV口径}} = \frac{\text{下单UV数}}{\text{点击UV数}} \\
\text{CVR}_{\text{PV口径}} = \frac{\text{下单PV数}}{\text{点击PV数}}
$$

- CTCVR（曝光转化率）
$$
\text{CTCVR}_{\text{曝光件次口径-订单量}} = \frac{\text{订单量}}{\text{曝光结果数}}
$$

- PGMV（单次曝光转化GVM）
$$
\text{PGMV}_{\text{成交口径}} = \frac{\text{订单总金额}}{\text{曝光结果数}}
$$

- 停留时长：分别按照PV和UV口径来统计。
- 浏览深度：按照单次PV下总共曝光坑位来进行统计。
- 多样性：
  - 电商领域：关注单次PV给用户展示了不同的三级类目的个数。
  - 内容领域：关注单次PV给用户展示的不同的内容题材的种数。
- 新颖性：从用户视角考虑，向用户推荐更多新物料，不让用户产生审美疲劳。

#### 1.3.2 内容社区推荐场景

- 互动率
$$
\text{互动率} = \frac{\text{互动数}}{\text{曝光数}}
$$

#### 1.3.3 短视频App推荐场景

- 人均视频播放量：反映了平台视频的整体质量
$$
\text{人均视频播放量} = \frac{\text{视频播放总量}}{\text{DAU}}
$$

- 人均观看时长

$$
\text{人均观看时长} = \frac{\text{视频播放总时长}}{\text{DAU}}
$$

- 视频有效播放率：设置观看时长阈值为3s，3s内的视频播放被视为无效播放。
$$
\text{视频有效播放率} = \frac{\text{视频有效播放量}}{\text{视频播放总量}} 
$$

- 视频完播率：用户看完完整视频的比例。
$$
\text{视频完播率} = \frac{\text{视频完整播放量}}{\text{视频播放总量}}
$$

## 2 推荐策略产品经理画像

- 电商推荐策略产品经理
  - 平台策略：平台整体的推荐流量分发策略。
  - 商家策略：行业策略或者垂类策略。
  - 用户策略：用户体验策略、用户画像策略和用户分层策略。
  - 内容策略：按照分发的物料类型区分。
  - 场景策略：针对首页推荐、商品详情页推荐、购物车推荐和我的主页推荐。
  - 创意策略：负责整个推荐场景的创意设计。
- 内容推荐策略产品经理
  - 平台策略：分级流量曝光机制
  - 垂类策略：电商平台涉及数码产品、时尚美妆等，短视频平台涉及发现页、同城页等。
  - 内容策略：短视频内容理解方面的策略和模型设计。
  - 样式创意策略：负责整个推荐模块的样式和创意策略设计工作，以及和前端用户体验相关的工作。

## 3 数据处理

- 常见的底层数据表

|      表名      | 存储的信息                                               | 表类型 | 选取时间 |
| :------------: | -------------------------------------------------------- | :----: | :------: |
|   商品信息表   | 商品的基本信息：标题、价格、图片等                       |  切片  | 最新切片 |
|   品类信息表   | 品类的基本信息：品类名、品类ID                           |  切片  | 最新切片 |
|   店铺信息表   | 店铺的基本信息：店铺名、开店时间、店铺拥有商品           |  切片  | 最新切片 |
|     订单表     | 平台历史交易的所有订单信息：成交时间、金额、用户等       |  增量  | 近3个月  |
| 用户注册信息表 | 用户注册的基本信息：手机号、用户名等                     |  切片  | 最新切片 |
|   用户画像表   | 基于各种数据表加工后的用户画像数据：商品偏好、品类偏好等 |  切片  | 最新切片 |
|   埋点数据表   | 平台上各个模块的埋点数据，记录用户的各种行为数据         |  增量  | 近3个月  |

- 数据表的加工：基于原始数据表建工，将很多表的数据进行汇总，得到一张加工好的最上层表。
- 数据归一化和标准化：
  - Min-Max（最小最大值）归一化：$\displaystyle x' = \frac{x - \min (x)}{\max (x) - \min (x)}$
  - 均值归一化：$\displaystyle x' = \frac{x - \text{mean} (x)}{\max (x) - \min (x)}$
  - Log对数函数归一化：$\displaystyle x' = \frac{\log_{10} (x)}{\log_{10} (\max)}$
  - 标准化：$\displaystyle x' = \frac{x - \mu}{\sigma}$

## 4 推荐系统召回策略

### 4.1 3种召回策略

- 规则召回
  - 优点：策略逻辑清晰，业务意义明确，可解释性极强。
  - 缺点：个性化弱，千人一面，容易引起马太效应。
- 协同过滤
  - 优点：算法逻辑相对比较简单，具备一定的个性化。
  - 缺点：冷启动问题明显，存在马太效应。
- 向量召回：通过嵌入分别表示用户和物料的特征，然后再计算相关性。
  - 优点：特征理解更加深刻，线上模型效果更优。
  - 缺点：模型可解释性很差，对算力要求更高。

### 4.2 多路召回架构

- 用户分层：按照消费频率、消费金额、最近一次消费时间对用户进行分层。
- 场景区分：对不同场景设计不同的召回策略。
- 多路召回的目的：提升推荐系统的整体效果和满足业务需求，使得模型整体变得更加灵活。
- 召回数量：”用户+场景+召回策略“决定了该路召回应该返回的数量。

### 4.3 基于规则的召回

- 标签召回：核心问题是如何构建科学全面的标签体系、如何为用户和内容达标，计算标签重合度。
- 质量分召回：
  - 质量分：用于评估物料质量的分数。
  - 计算公式：$\text{质量分} = a \times \text{商品订单量} + b \times \text{商品点击数} + c \times \text{商品点击率} + d \times \text{商品关注数} + e \times \text{商品好评率} - f \times \text{商品退货率} - g \times \text{商品返修率} - h \times \text{商品换货率}$
  - 质量因子归一化：将各个质量因子的分数归一化到同一个量级上，进行综合比较。
- 热门召回：基于订单表统计每个商品的订单数，使用最大最小值归一化，针对每个商品生成对应的热销分，筛选出销量比较高的商品。
- 高点击率召回：基于埋点数据表，召回平台上那些CTR（统计口径为曝光次数）相对比较高的物料。
- 复购召回：基于用户维度统计出每个用户经常购买的商品，计算商品对应偏好分。

### 4.4 基于协同过滤的召回

- 协同过滤机制：利用群体数据寻找规律，寻找物料与物料、用户与用户之间的相似性，然后再把相似性很低的物料和用户筛选出来并排除，从而挑选出相似性最高的物料和用户。
- 基于用户的协同过滤（UserCF算法）：
  - 挖掘与目标用户相似的用户集合，取相似度排在前几位的用户作为候选集。用户相似度的计算公式：$\displaystyle w_{AB} = \frac{|N(A) \cap N(B)|}{|N(A) \cup N(B)|}$
  - 挖掘该集合中受欢迎的物料，从中为目标用户推荐没有接触过的物料。计算用户$u$对商品$i$的兴趣度：$\displaystyle P_{(u, i)} = \sum_{v \in S(u, K) \cap N(i)} w_{uv} r_{vi}$
- 基于物料的协同过滤（ItemCF算法）：
  - 使用余弦相似度公式，计算商品之间的相似度。商品相似度的计算公式：$\displaystyle w_{ij} = \frac{|N(i) \cap N(j)|}{\sqrt{N(i)} \sqrt{N(j)}}$
  - 基于目标用户历史浏览行为和商品之间的相似度，为其推荐感兴趣且未浏览过的商品。计算用户$u$对商品$j$的兴趣度：$\displaystyle P_{(u, j)} = \sum_{i \in S(j, K) \cap N(u)} w_{ji} r_{ui}$

|          | UserCF                                                       | ItemCF                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 性能     | 适用于用户数较少的场景                                       | 适用于物料数明显小于用户数的场景                             |
| 应用领域 | 时效性较强，用户个性化不太明显的场景                         | 长尾物品丰富，用户更个性化需求强烈的领域                     |
| 冷启动   | 对于新用户，无法立即进行个性化推荐；对于新物料，一旦有用户对其产生行为，就可将新物料推荐给兴趣相似的其他用户。 | 对于新用户，只要对任一物料产生行为，可立即推荐相似物料；对于新物料，必须更新物料相似度表，才可将新物料推荐给用户。 |
| 可解释性 | 相对较弱                                                     | 相对较强                                                     |

- 基于图模型的方法
  - 将数据表格转化为二分图。
  - 基于两个顶点之间的路径数、路径长度及经过的节点出度判断相关性。

### 4.5 基于向量的召回

- 隐语义模型：通过用户的行为数据挖掘出隐含的特征，使用梯度下降法将一个共现矩阵（用户和物料的交互矩阵）分解成两个小矩阵。
- 隐语义模型的优点：泛化能力强、计算复杂度低、更好的灵活性和扩展性。
- 隐语义模型的缺点：没有加入用户、物料、上下文特征以及其他一些交互特征，具有一定的局限性。

### 4.6 双塔模型（DSSM）

- 核心思路：利用深度神经网络将文本表示为低维度的向量，将检索词（query）和文档（document）分别嵌入（embedding）成两个向量塔，然后计算两个向量之间的余弦相似度。
- 具体方案：
  - 针对用户和物料分别输入对应的相关特征，针对特征进行编码，再将所有特征拼接。
  - 经过DNN模型训练后，最终输出各自收敛的向量。
  - 在相同的特征维度空间上计算用户向量和物料向量的相似度。
- 优点：对用户塔和物料塔进行解耦，离线训练好相关数据后再进行线上部署。
- 缺点：没有用到用户和物料的交叉特征。

### 4.7 召回策略的效果评估

- 线上效果评估：AB Test小流量实验。
- 离线效果评估：主要评估单个召回分支返回的物料和实际线上曝光与点击物料之间的重合度。
- 各路召回的贡献度归因：
  - 将物料归因到每一路，对每一路召回分支都计算相同的贡献。
  - 基于各路召回分支返回时的该物料的归一化分数，将其统一到同一量纲下进行对比，最终归入召回分支分数最高的一路。
  - 按照权重进行归因，对该物料在各路分支的分数进行汇总，按照每一路分支的贡献进行拆分。

## 5 推荐系统粗排策略

- 基于规则的粗排策略：对每一路召回设置一个权重系数，加权汇总后再进行统一排序，筛选出前几位的物料。
- 基于模型的粗排策略：
  - 计算公式：
$$
\text{CTR}_{\text{粗排}}(\text{召回点击率}) = \frac{\text{曝光点击数}}{\text{召回物料数}}
$$
  - 使用DNN模型
  - 样本：正样本是线上曝光且用户点击的物料，负样本所有召回但用户未点击的物料。
- 效果评估：
  - 线上：AB Test小流量实验
  - 离线：关注AUC指标、对比精排模型的物料重合度，重合度越高，粗排策略效果越好。

## 6 推荐系统精排策略

### 6.1 学习目标

- 电商场景的核心目标：预估用户对物料的CTR（曝光点击率）
- 内容推荐场景的核心目标：采用多目标（DAU、用户使用时长）排序的方法。
  - 正反馈指标：显性指标是点赞、分享、收藏、正向评论；隐性指标是观看时长、完播率、有效播放率等。
  - 负反馈指标：显性指标是负反馈点击、举报、负向评论；隐性指标是短播放、停止浏览等。

### 6.2 算法选择

- 使用DNN算法
- 预估CTR时，可以使用LR或者LR+GBDT算法。

### 6.3 特征构造

- 静态特征：用户特征和物料特征
- 请求特征：请求ID、请求时间
- 用户基本画像特征：用户ID、性别、下单总数、平均下单数、订单总金额、订单平均金额、订单最大/最小金额、购买过多少不同一级/二级/三级类目商品、购买过多少不同品牌商品，按照一级/二级/三级类目分别统计下单数/下单总金额/下单平均金额。
- 用户商品画像特征：用户ID、商品ID、用户以前订单中含有该商品的订单数、商品的数量、该商品的价格、用户以前购买过的和该商品属于同一个一级/二级/三级类目的商品种类数、用户在一级/二级/三级类目下购买的商品总订单量/下单的总金额、以前购买过和该商品属于同一个品牌的商品种类数、用户购买过的同一个品牌的商品总数量、用户购买过的同一个品牌的总价格。
- 行为序列特征：用户的点击序列、加购序列、下单序列、观看序列等。
- 交叉特征

### 6.4 特征选择

- 业务经验法：基于对实际业务场景的理解进行特征构建和特征选择，完全凭借人工经验和业务知识。
  - 优点：可以快速构建一批价值比较高的特征，实现模型的快速上线。
  - 缺点：高度依赖人工经验。
- 过滤法：从特征本身以及特征和样本标签的相关性出发进行选择。
  - 优点：不依赖模型训练和模型实际效果评估，缩短特征选择流程。
  - 缺点：对于不同特征组合带来的效果无法进行有效的评估，无法有针对性地挖掘适应当前业务场景和模型的最佳组合。
- 封装法：
  - 序列前向选择：从空集开始，逐个加入特征，然后评估实际模型效果。
  - 序列后向选择：从全量特征开始，逐个去除特征，选择效果最优的特征集合。
  - 优点：基于模型实际效果选出来的特征子集，在理论上是最佳的。
  - 缺点：选择流程长，模型需要重复训练，时间成本高，计算量大。
- 嵌入法

### 6.5 特征编码

- one-hot编码（独热编码）
- 分桶编码：先划分区间，然后转化为0-1编码。
- 向量映射编码

### 6.6 模型训练

- 构建训练样本：将请求特征、用户画像特征、用户商品画像特征等组成一张大宽表，再附加标签。
- 基于训练样本进行模型训练：使用梯度下降法进行迭代训练，使得损失函数的值逐步最小。
$$
loss = \min \left ( \sum_{i=1}^N (h_w(x_i) - y_i)^2 + \lambda \| w \|_1 + \lambda \| w \|_2^2 \right )
$$
- 输出收敛的模型：经过多轮训练，最终模型收敛，得到一组最优的参数$w$。

### 6.7 效果评估

离线效果评估主要关注AUC指标，超过0.7才可能在线上有比较明显的正向效果。

### 6.8 模型应用和迭代

- 不用专门的线上AB Test小流量测试。
- 以天为单位进行一次模型自学习。

## 7 推荐系统重排策略


